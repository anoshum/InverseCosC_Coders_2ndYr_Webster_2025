<!--
This HTML file represents a complaint submission page called "Fixit".
It allows users to submit public complaints (like road damage, drains, etc.)
and view a list of latest complaints. Tailwind CSS is used for styling.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixit</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Tailwind CSS styling section -->
    <style type="text/tailwindcss">
        body{
            @apply bg-gradient-to-br from-emerald-200/60 via-teal-200/50 to-lime-100/60 backdrop-blur-2xl bg-cover bg-center font-sans h-screen;
        }
        button{
            @apply bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded;
        }
        .logo{
            @apply font-bold text-2xl p-3;
        }
        .form{
            @apply bg-[#FCD2FF] p-6 rounded-lg shadow-md m-4 w-2/3;
        }
        .form h3{
            @apply text-2xl font-bold mb-4;
        }
        .form div{
            @apply mb-4;
        }
        .form label{
            @apply text-black font-bold mb-2;
        }
        option{
            @apply text-black bg-purple-200;
        }
        .form select, .form textarea, .form input[type="text"], .form input[type="file"]{
            @apply w-full p-2 border border-black rounded;
        }
        .latest-complain{
            @apply bg-[#FCD2FF] p-6 rounded-lg shadow-md m-4 w-1/3;
        }
        .main-page{
            @apply w-full flex flex-row;
        }
        .latest-complain h2{
            @apply text-2xl font-bold mb-4;
        }
        .complain-item{
            @apply border-b border-black pb-4 mb-4 flex;
        }
        .complain-item img{
            @apply w-16 h-16 mr-4;
        }
        .complain-item h4{
            @apply text-lg font-bold;
        }
        .complain-item h5{
            @apply text-sm text-green-500;
        }
        .complain-item p{
            @apply text-sm text-black;
        }
        footer{
            @apply bg-[#970FF2] text-white p-2 text-center;
        }
        .footer-content p{
            @apply text-lg my-2;
        }
        .image-upload input{
            @apply mt-2 border border-black rounded p-2;
        }
        #map {
            height: 300px;
            width: 100%;
            margin-top: 12px;
            border: 2px solid black;
            border-radius: 8px;}
    </style>
    <!-- End of head section -->
</head>
<body>
    
    <!-- Header section with navigation buttons -->
    <header class="flex bg-[#970FF2] text-white p-2 justify-between m-2 rounded-lg">
        <div class="logo ">FiksIt</div>
        <div class="nav-links flex gap-9 my-2 mx-2">
            <a href='/'><button>Home</button></a>
            <a href='/dashboard'><button>Dashboard</button></a>
        </div>
    </header>
    
    <!-- Main section containing the complaint form and latest complaints -->
    <main>
        <div class="main-page">
            <!-- Complaint submission form -->
            <form class="form" action='sc' method='post' enctype='multipart/form-data'>
              {%csrf_token%}
                <h3>Submit a New Complain</h3>
                <div>
                    <div  class="catogery">Catogery</div>
                    <input type='hidden' name='un' value={{usern}}>
                    <select name="cat" id="category">
                        <option value="">Select a category</option>
                        <option value="Civil">Civil</option>
                        <option value="Electricity">Electricity</option>
                        <option value="Sanitary">Sanitary</option>
                        <option value="Water">Water</option>
                        
                    </select>
                    <div class="description">Description</div>
                    <textarea name="desc" cols="20" rows="5" placeholder="Describe your issue..."></textarea>
                    <input type="text" class="mb-2" name="lm" id="Landmark" placeholder="Enter a landmark...">
                    <div id="locationForm">
                        <div class="controls">
                        <button type="button" id="btnLocate">Use my device location</button>
                        </div>
                        <div class="inputs flex gap-4 mt-2">
                            <div>
                                <label>Latitude</label>
                                <input id="latitude" name='lat' type="text" placeholder="Latitude" readonly>
                            </div>
                            <div>
                                <label>Longitude</label>
                                <input id="longitude" name='long' type="text" placeholder="Longitude" readonly>
                            </div>
                        </div>
                        <div class="hint" id="permissionHint">You can also click on the map to choose a location.</div>
                        <div class="error" id="errMsg" style="display:none"></div>
                      </div>
                    <div id="map"></div>

                    <div class="image-upload">
                        <label for="image">Upload Image</label>
                        <input type="file" id="image" name="image" >
                    </div>
                </div>
             <input type='submit' class='btn btn-primary'>
            </div>
                        <!-- Section showing the latest complaints -->
            
        </div>
    </main>
    
    <!-- Footer section -->
    <footer>
        <div class="footer-content">
            <p>Made by team InverseCosC_Coders ðŸ˜Ž</p>
        </div>
    </footer>
    <script>
  // Basic Leaflet setup
  var map = L.map('map').setView([25.493668, 81.863350], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  var marker = null;

  // Helper to set marker and inputs
  function setLocation(lat, lng, openPopup=false) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map);
    if (openPopup) marker.bindPopup('Selected location').openPopup();

    document.getElementById('latitude').value = parseFloat(lat).toFixed(6);
    document.getElementById('longitude').value = parseFloat(lng).toFixed(6);
  }

  // Map click fallback for manual selection
  map.on('click', function(e) {
    var lat = e.latlng.lat, lng = e.latlng.lng;
    setLocation(lat, lng, true);
    hideError();
  });
  var btnLocate = document.getElementById('btnLocate');
  var errBox = document.getElementById('errMsg');
  function showError(msg) {
    errBox.style.display = 'block';
    errBox.textContent = msg;
  }
  function hideError() {
    errBox.style.display = 'none';
    errBox.textContent = '';
  }

  // Options for geolocation
  var geoOptions = {
    enableHighAccuracy: true,
    timeout: 10000,     
    maximumAge: 0
  };

  // Function to request current position (shows browser permission prompt)
  function requestCurrentPosition() {
    if (!('geolocation' in navigator)) {
      showError('Geolocation API not supported by your browser.');
      return;
    }

    if (navigator.permissions && navigator.permissions.query) {
      navigator.permissions.query({ name: 'geolocation' }).then(function(status) {
        if (status.state === 'denied') {
          showError('Location permission is blocked. Please enable location for this site in browser settings and try again.');
          return;
        }

        getPosition();
      }).catch(function() {
        getPosition();
      });
    } else {
      getPosition();
    }

    function getPosition() {
      hideError();
      navigator.geolocation.getCurrentPosition(function(position) {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        setLocation(lat, lng, true);
        // Zoom-in a bit
        map.setView([lat, lng], 16);
      }, function(err) {
        // Error callback
        switch(err.code) {
          case err.PERMISSION_DENIED:
            showError('Permission denied. You can still choose a location by clicking on the map.');
            break;
          case err.POSITION_UNAVAILABLE:
            showError('Position unavailable. Try again or pick a location manually.');
            break;
          case err.TIMEOUT:
            showError('Request timed out. Try again or pick a location manually.');
            break;
          default:
            showError('Error getting location: ' + err.message);
        }
      }, geoOptions);
    }
  }

  btnLocate.addEventListener('click', requestCurrentPosition);

  // Optional: center the map to currently selected coordinates
  document.getElementById('btnCenter').addEventListener('click', function() {
    var lat = parseFloat(document.getElementById('latitude').value);
    var lng = parseFloat(document.getElementById('longitude').value);
    if (!isNaN(lat) && !isNaN(lng)) {
      map.setView([lat, lng], 16);
    } else {
      showError('No location selected yet. Use "Use my device location" or click on the map.');
    }
  });

  // Demo submit handler (replace with real form send to server)
  document.getElementById('locationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    var name = document.getElementById('name').value.trim();
    var lat = document.getElementById('latitude').value.trim();
    var lon = document.getElementById('longitude').value.trim();
    if (!name) {
      showError('Please enter your name.');
      return;
    }
    if (!lat || !lon) {
      showError('Please select a location (either allow device location or pick on the map).');
      return;
    }
    hideError();
    // Here you would send `name`, `lat`, `lon` to your server via fetch/ajax
    // Example:
    // fetch('/submit', { method:'POST', body: JSON.stringify({name, lat, lon}), headers: {'Content-Type':'application/json'} })
    alert('Form ready to submit:\\nLat: ' + lat + '\\nLon: ' + lon);
  });
  </script>
</body>
</html>